#!/usr/bin/env bash

clear
set -e
URL=$1

# ==============================
# Directories & Detect platform
# ==============================
if [ -d "/sdcard" ]; then
    # Likely Termux / Android
    STD_DIR="/sdcard/MyDownloads"
    MUSIC_DIR="$STD_DIR/%(extractor)s_music"
    VIDEO_DIR="$STD_DIR/%(extractor)s_video"
    PLAYLIST_MUSIC_DIR="$STD_DIR/%(playlist_title)s"
    PLAYLIST_VIDEO_DIR="$STD_DIR/%(playlist_title)s"
else
    # Likely Linux Desktop
    STD_DIR="$HOME/MyDownloads"
    MUSIC_DIR="$STD_DIR/%(extractor)s_music"
    VIDEO_DIR="$STD_DIR/%(extractor)s_video"
    PLAYLIST_MUSIC_DIR="$STD_DIR/%(playlist_title)s"
    PLAYLIST_VIDEO_DIR="$STD_DIR/%(playlist_title)s"
fi

# Name
MUSIC_NAME="%(title)s.%(ext)s"
VIDEO_NAME="%(title)s_%(height)s"p".%(ext)s"
REELS_NAME="%(extractor)s_%(id)s.%(ext)s"
PLAYLIST_MUSIC_NAME="%(playlist_index)02d_%(title)s.%(ext)s"
PLAYLIST_VIDEO_NAME="%(playlist)s/%(playlist_index)02d_%(title)s_%(height)s"p".%(ext)s"

# venv dir
VENV_DIR="$HOME/.venv"
# === NORMAL / BRIGHT COLORS ===
RED_B=$'\033[91m'       # bright red
GRN_B=$'\033[92m'       # bright green
YEL_B=$'\033[93m'       # bright yellow
CYN_B=$'\033[96m'       # bright cyan
MAG_B=$'\033[95m'       # bright magenta
RESET=$'\033[0m'        # reset color

# === GRADIENT COLORS (256-color mode) ===
GRAD_1=$'\033[38;5;39m'     # cyan blue
GRAD_2=$'\033[38;5;63m'     # bluish purple
GRAD_3=$'\033[38;5;99m'     # soft violet
GRAD_6=$'\033[38;5;201m'    # bright pink-magenta

show_help() {
  Asep5K
    cat <<EOF
  ${0##*/} - Simple CLI wrapper for yt-dlp with extras
Usage:
  ${0##*/} [OPTIONS]/[URL]

Example:
  ${0##*/} https://youtu.be/7kHxblDGbGw   # Download video/music
  ${0##*/} -c                             # Check yt-dlp updates
  ${0##*/} -u                             # Update yt-dlp

Options:
  -c            Check for yt-dlp updates
  -u            Update yt-dlp
  -h, --help    Show this help message

Note:
  If a URL is provided, it must start with http:// or https://
EOF
}

# Banner ASCII Art
Asep5K() {
    cat <<EOF
    ___                    ________ __
   /   |  ________  ____  / ____/ //_/
  / /| | / ___/ _ \/ __ \/___ \/ ,<   
 / ___ |(__  )  __/ /_/ /___/ / /| |  
/_/  |_/____/\___/ .___/_____/_/ |_|  
                /_/                   
EOF
}


setup_package () {
    package_install ffmpeg
    package_install mpv
    package_install atomicparsley
    if [[ "$(uname -o)" == "Android" ]]; then
        if ! command -v atomicparsley >/dev/null 2>&1; then
            ln -s AtomicParsley /data/data/com.termux/files/usr/bin/atomicparsley 2>/dev/null || true
        fi
    fi
    setup_venv
}

# check updates
check_updates() {
    clear
    echo "ðŸ”Ž Checking yt-dlp updates..."
    current=$(yt-dlp --version)
    latest=$(curl -s https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest \
      | grep '"tag_name":' \
      | cut -d '"' -f4)

    if [ "$current" != "$latest" ]; then
        echo "yt-dlp version: $current"
        echo "New update version: $latest"
    else
        echo "yt-dlp version: $current"
    fi
}

# Connection check
check_internet() {
    if ! ping -c 1 8.8.8.8 >/dev/null 2>&1; then
        echo "âœ– No Internet" "Please check your connection!"
        exit 1
    fi
}

# URL validation
validate_url() {
    if [[ "$1" =~ ^https?:// ]]; then
        return 0  # valid
    else
        clear
        echo -e "${RED_B}âœ– Invalid URL. Must start with http:// or https://${RESET}"
        return 1  # invalid
    fi
}

# Prompt user for new URL
new_url() {
    while true; do
        read -p "Enter URL (or 'e' to Exit): " URL
        [ "$URL" = "e" ] && clear && exit 0

        if validate_url "$URL"; then
            break
        fi
    done
}

input_url() {
    if [ -z "$URL" ]; then
        new_url
        if validate_url "$URL"; then
            echo "âœ” Valid URL: $URL"
        else
            new_url
        fi
    fi
}

invalid() {
    clear 
    echo -e ${RED_B}"Invalid choice, try again!"${RESET}
}
# Package installer (cross-distro)
package_install() {
    local package="$1"
    if ! command -v "$package" >/dev/null 2>&1; then
        echo "âš  $package not found! installing..."
        if command -v pkg >/dev/null 2>&1; then
            pkg install -y "$package" 
        elif command -v pacman >/dev/null 2>&1; then
            sudo pacman -S --noconfirm "$package"
        elif command -v dnf >/dev/null 2>&1; then
            sudo dnf install -y "$package"
        elif command -v zypper >/dev/null 2>&1; then
            sudo zypper install -y "$package"
        elif command -v apt >/dev/null 2>&1; then
            sudo apt update && sudo apt install -y "$package"
        else
            echo "Error: No supported package manager found."
            echo "Please install $package manually"
            return 1
        fi
    fi
}

# Update yt-dlp
yt-dlp_update() {
    clear
    while true; do
    cat << EOF
Select which version of yt-dlp to update: 
1. yt-dlp (default release)
2. yt-dlp (nightly build)
b. back
e. exit
EOF
      read -n 1 -p "Enter your choice [1/2]: " choice
      echo ""
      # setup_venv
      case $choice in
          1) python3 -m pip install -U "yt-dlp[default]" mutagen && echo "âœ… Installation completed successfully.";;
          2) python3 -m pip install -U --pre "yt-dlp[default]" mutagen && echo "âœ… Nightly installation completed successfully.";;
          b) clear; return ;;
          e) clear; exit 0 ;;
          *) echo "âŒ Invalid choice.";;
      esac

         echo "All done!"
    done
}

# check updates
check_updates() {
    clear
    echo "ðŸ”Ž Checking yt-dlp updates..."
    current=$(yt-dlp --version)
    latest=$(curl -s https://api.github.com/repos/yt-dlp/yt-dlp/releases/latest \
      | grep '"tag_name":' \
      | cut -d '"' -f4 | sed 's/^v//')

    if [ "$current" != "$latest" ]; then
        echo "Your version: $current"
        echo "New update available: $latest"
    else
        echo "You have the latest version: $current"
    fi
}

# General download function
download_file() {
    clear
    Asep5K
    local type="$1"
    local outdir="$2"
    local name="$3"
    local format="$4"
    local extra_opts="-q --progress -c --no-warnings --convert-thumbnails none --extractor-retries infinite --restrict-filenames --embed-metadata --embed-thumbnail"
    local file="$outdir/$name"
    echo "Downloading $type... Please wait..."

    if [ "$format" = "flac" ]; then
        yt-dlp -x --audio-format flac --audio-quality 0 \
          --restrict-filenames -o "$file" "$URL"

    elif [ "$format" = "mp3" ]; then
        yt-dlp -t mp3 $extra_opts --audio-quality 0 -o "$file" "$URL"

    elif [ "$format" = "mp4" ]; then
        if [ "$type" = "best" ] || [ "$type" = "Reels" ]; then
            yt-dlp $extra_opts -f "bv[vcodec^=avc1]+bestaudio / bv[vcodec^=av01]+bestaudio / best" \
            -t "$format" -o "$file" "$URL"

        else
            yt-dlp $extra_opts  -f "bv[height<="$type"][vcodec^=avc1]+bestaudio / bv[height<="$type"][vcodec^=av01]+bestaudio" \
            -t "$format" -o "$file" "$URL"
        fi
    else
        echo "âœ– Unknown format $format"
    fi

    if [ $? -eq 0 ]; then
        echo "âœ” Download finished."
    else
        echo "âœ– Download Failed. Check the URL or network."
    fi
}

# Show available formats/size
size_check() {
    clear
    Asep5K
    yt-dlp -F "$URL"
}

# Play video/music with mpv
play_select() {
    if [ "$1" = "best" ]; then
        mpv --ytdl-format="bv[vcodec^=avc1]+bestaudio / best" "$URL" & 
    elif [ "$1" == "music" ]; then
        mpv --no-video "$URL" &
    else    
        mpv --ytdl-format="bv[height<=$1][vcodec^=avc1]+bestaudio / bv[height<=$1][vcodec^=av01]+bestaudio" "$URL" &
    fi
}

play() {
    clear
    Asep5K
    package_install mpv
    while true; do
        echo "[Play Options]"
        cat << EOF
1. Music
2. 240p
3. 360p
4. 480p
5. 720p
6. 1080p
7. 2K (1440p)
8. 4K (2160p)
9. Best Resolution
b. Back
n. New url
e. Exit
EOF

        read -n 1 -p "Enter your choice: " choice
        echo ""
        case "$choice" in
            1) play_select "music" >/dev/null ;;
            2) play_select 240 >/dev/null ;;
            3) play_select 360 >/dev/null ;;
            4) play_select 480 >/dev/null ;;
            5) play_select 720 >/dev/null ;;
            6) play_select 1080 >/dev/null ;; 
            7) play_select 1440 >/dev/null ;;
            8) play_select 2160 >/dev/null ;;
            9) play_select "best" >/dev/null ;;
            b) return ;;
            n) new_url ;;
            e) exit 0 ;;
        esac  
    done
}
# video mp4 func
download_videos_mp4() {
    clear
    input_url
    while true; do
        Asep5K
        cat << EOF
${GRAD_1}[Video Options (MP4)]
${GRAD_6}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${RESET}
 [1] 240p
 [2] 360p
 [3] 480p
 [4] 720p
 [5] 1080p
 [6] 2k (1440p)
 [7] 4k (2160p)
 [8] Best Resolution
 [b] Back
 [n] New url
${RED_B} [e] Exit
${GRAD_6}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›${RESET}          
EOF
        
        read -n 1 -p "Enter your choice: " choice
	echo ""

        case "$choice" in
            1) download_file 240 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            2) download_file 360 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            3) download_file 480 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            4) download_file 720 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            5) download_file 1080 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            6) download_file 1440 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            7) download_file 2160 "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            8) download_file "best" "$VIDEO_DIR" "$VIDEO_NAME" "mp4" ;;
            b) clear; return ;;  # Back
            n) new_url ;;
            e) clear; exit 0 ;;
            *) invalid ;;
        esac
    done
}
# playlist download func
playlist_download() {
    clear
    input_url
    while true; do
        Asep5K
        cat << EOF
${GRAD_1}[Video Playlist Options]
${GRAD_3}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${RESET}
 [1] â± 240p
 [2] â± 360p
 [3] â± 480p
 [4] â± 720p
 [5] â± 1080p
 [6] â± 2K (1440p)
 [7] â± 4K (2160p)
 [8] â± Best Resolution
 [b] â± Back
 [n] â± New url
${RED_B} [e] â± Exit
${GRAD_3}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›${RESET}      
EOF

        read -n 1 -p "Enter your choice: " choice
	echo ""

        case "$choice" in
            1) download_file 240 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            2) download_file 360 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            3) download_file 480 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            4) download_file 720 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            5) download_file 1080 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            6) download_file 1440 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            7) download_file 2160 "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            8) download_file "best" "$PLAYLIST_VIDEO_DIR" "$PLAYLIST_VIDEO_NAME" "mp4";;
            b) clear; return ;;  # Back
            n) new_url ;;
            e) clear; exit 0 ;;
            *) invaid;;
        esac
    done
}


# music download func
music_download() {
    clear
    input_url
    while true; do
        Asep5K
        cat << EOF
${YEL_B}[Download Music Options]
${GRAD_2}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${RESET}
 [1] â± Mp3
 [2] â± Flac
 [3] â± Playlist Mp3
 [4] â± Playlist Flac
 [b] â± Back
 [n] â± New url
${RED_B} [e] â± Exit${RESET}
${GRAD_2}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›${RESET}
EOF

        read -n 1 -p "Enter your choice: " choice
	echo ""

        case "$choice" in
            1) download_file "mp3" "$MUSIC_DIR" "$MUSIC_NAME" "mp3" ;;
            2) download_file "flac" "$MUSIC_DIR" "$MUSIC_NAME" "flac" ;;
            3) download_file "playlistmp3" "$PLAYLIST_MUSIC_DIR" "$PLAYLIST_MUSIC_NAME" "mp3" ;;
            4) download_file "playlistflac" "$PLAYLIST_MUSIC_DIR" "$PLAYLIST_MUSIC_NAME" "flac" ;;
            b) clear; return ;;  # Back
            n) new_url ;;
            e) clear; exit 0 ;;
            *) invalid;;
        esac
    done
}
# reels download  func
all_platform() {
    clear
    input_url
    while true; do
        Asep5K
        cat << EOF
   ${RED_B}rm -rf /
${GRAD_1}â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${RESET}
 [1] Reels
 [2] Audio
 [b] Back
 [n] New url
${RED_B} [e] Exit${RESET}
${GRAD_1}â”—â”â”â”â”â”â”â”â”â”â”â”â”â”›${RESET}
EOF

        read -n 1 -p "Enter your choice: " choice
	echo ""

        case "$choice" in
            1) download_file "Reels" "$VIDEO_DIR" "$REELS_NAME" "mp4" ;;
            2) download_file "audio" "$MUSIC_DIR" "$REELS_NAME" "mp3" ;;
            b) clear; return ;;  # Back
            n) new_url ;;
            e) clear; exit 0 ;;
            *) echo "Invalid choice, try again!" ;;
        esac
    done
}
# Main menu
main_menu() {
    # ==========================
    # Init checks
    # ==========================
    check_internet 
    setup_package
    while true; do
        Asep5K
        cat << EOF
${CYN_B}             [Download Options]
${RED_B}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“${RESET}
 [1] â± Reels / Shorts / Clips [Video / Audio]
 [2] â± Download Video MP4
 [3] â± Download Video Playlist
 [4] â± Download Music [MP3 / FLAC]
 [5] â± Play [Video / Music]
 [6] â± Check Download Size
${CYN_B}        [I use arch BTW]${RESET}
 [c] â± Check for yt-dlp Updates
 [h] â± Show Help
 [n] â± New Url
 [u] â± Update yt-dlp
${RED_B} [e] â± Exit
â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›${RESET}
EOF

        read -n 1 -p "Enter your choice: " choice
        echo ""
        case "$choice" in
            1) all_platform ;;
            2) download_videos_mp4 ;;
            3) playlist_download ;;
            4) music_download ;;
            5) play ;;
            6) size_check ;;
            c) check_updates ;;
            h) clear; show_help ;;
            n) new_url ;;
            u) yt-dlp_update ;;
            e) clear; exit 0 ;;
            *) invalid ;;
        esac
    done
}
setup_venv() {
     if [[ ! -d "$VENV_DIR" ]]; then
          python3 -m venv "$VENV_DIR"
     fi
     source "$VENV_DIR/bin/activate"     
     if ! command -v yt-dlp >/dev/null 2>&1; then 
          echo "yt-dlp not found"
     while true; do
     cat << EOF
Select which version of yt-dlp to install: 
1. yt-dlp (default release)
2. yt-dlp (nightly build)
EOF
          read -n 1 -p "Enter your choice [1/2]: " choice
          echo ""
          # setup_venv
          case $choice in
              1)python3 -m pip install -U "yt-dlp[default]" mutagen && clear; return;echo "âœ… Installation completed successfully.";;
              2)python3 -m pip install -U --pre "yt-dlp[default]" mutagen && clear; return; echo "âœ… Nightly installation completed successfully.";;
              *)clear;echo "âŒ Invalid choice.";;
          esac

          echo "All done!"
     done
     fi
}


# ==========================
# Exit trap
# ==========================
trap 'cat << "EOF"
ï¼´ï½ˆï½ï½Žï½‹ï½“  ï½†ï½ï½’  ï½•ï½“ï½‰ï½Žï½‡
EOF
exit 0' EXIT

# ==========================
# URL Input
# ==========================
case $URL in
  -c) check_updates && exit 0 ;;
  -u) yt-dlp_update && exit 0 ;;
  -h|--help) show_help && exit 0 ;;
esac

# ==========================
# Main Menu
# ==========================
main_menu
